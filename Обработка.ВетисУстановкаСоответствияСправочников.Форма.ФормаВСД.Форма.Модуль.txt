
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	НомерСкладаПриИзменении();
	
КонецПроцедуры

&НаКлиенте
Процедура СписокВетисЗаполнить(Команда)
	
	СписокВетисЗаполнитьСервер();
	
КонецПроцедуры

&НаСервере
Процедура СписокВетисЗаполнитьСервер()
	
	СписокВетис.Очистить();
	
	_ListRequest = ВетисMercuryApplications.getVetDocumentListRequest(enterpriseGuid);
	
	_Отладка = кпс.РазрешенаОтладка();
	
	Пока Истина Цикл
		
		_Response = ВетисОбщегоНазначения.ВыполнитьЗапрос(_ListRequest, "getVetDocumentListRequest", Ложь, _Отладка);
		
		Если _Response = Ложь Тогда Прервать;	КонецЕсли;
		
		_ListResponse = ВетисMercuryApplications.getVetDocumentListResponse(_Response);
		
		Для Каждого _Item из ВетисMercuryVetdocument.VetDocumentListИтератор(_ListResponse) Цикл
			
			transferPermit = ВетисОбщегоНазначения.ПолучитьЗначение(_Item, "transferPermit");
			
			transportInfo = ВетисОбщегоНазначения.ПолучитьЗначение(_Item, "transportInfo");
			
			ТаблицаСтрока = СписокВетис.Добавить();
			
			ТаблицаСтрока.cargoExpertized = ВетисBase.xsBoolean(_Item.cargoExpertized);
			
			ТаблицаСтрока.confirmedBy = _Item.confirmedBy.fio;
			
			// получатель
			ТаблицаСтрока.consignee = ВетисСоответствие.ПолучитьСсылку(_Item.consignee.businessEntity.guid, "Справочник.Организации");
			//ТаблицаСтрока.consignee = ВетисСоответствие.ПолучитьСсылку(_Item.consignee.businessEntity.guid, "Справочник.Контрагенты");
			
			// отправитель
			//ТаблицаСтрока.consignor = ВетисСоответствие.ПолучитьСсылку(_Item.consignor.businessEntity.guid, "Справочник.Организации");
			ТаблицаСтрока.consignor = ВетисСоответствие.ПолучитьСсылку(_Item.consignor.businessEntity.guid, "Справочник.Контрагенты");
			
			ТаблицаСтрока.expertiseInfo = ВетисОбщегоНазначения.ПолучитьЗначение(_Item, "expertiseInfo");
			
			ТаблицаСтрока.form = ВетисMercuryVetdocument.VetDocumentFormОписание(_Item.form);
			
			ТаблицаСтрока.issueDate = ВетисBase.xsDate(_Item.issueDate);
			
			ТаблицаСтрока.locationProsperity = _Item.locationProsperity;
			
			ТаблицаСтрока.purpose = ВетисСоответствие.ПолучитьСсылку(_Item.purpose.guid, "Справочник.ВетисPurpose");
			
			ТаблицаСтрока.status = ВетисMercuryVetdocument.VetDocumentStatusОписание(_Item.status);
			
			ТаблицаСтрока.transferPermit = ?(transferPermit = Неопределено, "", "№" + _Item.transferPermit.issueNumber + " от " + _Item.transferPermit.issueDate);
			
			ТаблицаСтрока.transportInfo = ?(transportInfo = Неопределено, "", "номер: " + _Item.transportInfo.transportNumber.vehicleNumber);
			
			ТаблицаСтрока.transportType = ?(transportInfo = Неопределено, "", Перечисления.ВетисTransportType.Получить(Число(_Item.transportInfo.transportType)-1));
			
			ТаблицаСтрока.transportStorageType = Перечисления.ВетисTransportStorageType.Получить(ВетисArgusShipment.TransportationStorageTypeИндекс(_Item.transportStorageType)-1);
			
			ТаблицаСтрока.type = ВетисMercuryVetdocument.VetDocumentTypeОписание(_Item.type) + " ВСД";
			
			ТаблицаСтрока.waybill = ВетисArgusShipment.WaybillTypeОписание(_Item.waybillType, "ТТН") + " №" + _Item.waybillNumber + " от " + ВетисBase.xsDate(_Item.waybillDate);
			
			ТаблицаСтрока.uuid = _Item.uuid;
		КонецЦикла;
		
		Если НЕ ВетисMercuryApplications.getVetDocumentListRequestСледующий(_ListRequest, _ListResponse) Тогда
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	//СписокВетис.Сортировать("name");
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьСвязь(Команда)
	
	ТекущиеДанные = Элементы.СправочникСписок.ТекущиеДанные;
	
	СоздатьСвязьСервер(ТекущиеДанные.Ссылка);
	
	Элементы.СправочникСписок.Обновить();
	
КонецПроцедуры

&НаСервере
Процедура СоздатьСвязьСервер(п1сСсылка) Экспорт
	
	_ТекДанные = СписокВетис.НайтиПоИдентификатору(Элементы.СписокВетис.ТекущаяСтрока);
	
	Если Элементы.СправочникСписок.ВыделенныеСтроки.Количество() > 0 Тогда
		Для Каждого _ТекДанные1с из Элементы.СправочникСписок.ВыделенныеСтроки Цикл
			
			ВетисСоответствие.Добавить(_ТекДанные1с.Ссылка, _ТекДанные.guid, _ТекДанные.name);
			
		КонецЦикла;
		
	Иначе
		ВетисСоответствие.Добавить(п1сСсылка, _ТекДанные.guid, _ТекДанные.name);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура УдалитьСвязь(Команда)
	
	УдалитьСвязьСервер();
	
	Элементы.СправочникСписок.Обновить();
	
КонецПроцедуры

&НаСервере
Процедура УдалитьСвязьСервер()
	
	Если Элементы.СправочникСписок.ВыделенныеСтроки.Количество() > 0 Тогда
		Для Каждого _ТекДанные из Элементы.СправочникСписок.ВыделенныеСтроки Цикл
			
			ВетисСоответствие.Удалить(_ТекДанные.Ссылка);
			
		КонецЦикла;
	Иначе
		_ТекДанные = Элементы.СправочникСписок.ТекущиеДанные;
		
		ВетисСоответствие.Удалить(_ТекДанные.Ссылка);
		
	КонецЕсли;
	
КонецПроцедуры


&НаКлиенте
Процедура СписокВетисВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	//_ТекДанные = Элементы.СписокВетис.ТекущиеДанные;
	//
	//Элементы.СправочникСписок.ТекущаяСтрока = СправочникСписокНайти(_ТекДанные.name)
	
КонецПроцедуры

Функция СправочникСписокНайти(пНаименование)
	
	Возврат Справочники.КлассификаторЕдиницИзмерения.НайтиПоНаименованию(пНаименование);
	
КонецФункции


&НаКлиенте
Процедура СправочникСписокВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	//_ТекДанные = Элементы.СправочникСписок.ТекущиеДанные;
	//
	//_СписокВетисСтроки = СписокВетис.НайтиСтроки(Новый Структура("name", _ТекДанные.name));
	//
	//Если _СписокВетисСтроки.Количество() = 0 Тогда
	//	Возврат;
	//КонецЕсли;
	//
	//Элементы.СписокВетис.ТекущаяСтрока = _СписокВетисСтроки[0].ПолучитьИдентификатор();
	
КонецПроцедуры


&НаКлиенте
Процедура НомерСкладаПриИзменении(Элемент = Неопределено)
	
	enterpriseGuid = ВетисПараметрыСоединения.enterpriseGuid(НомерСклада);
	
	_Склад = ВетисCerberusEnterprise.GetEnterpriseByGuid(enterpriseGuid);
	
	Склад = _Склад.address.addressView;
	
КонецПроцедуры

