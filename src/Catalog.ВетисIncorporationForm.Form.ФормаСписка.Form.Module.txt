
&НаКлиенте
Процедура Заполнить(Команда)
	
	ЗаполнитьСервер();
	
	Элементы.Список.Обновить();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСервер()
	
	_ТаблицаВетис = Новый ТаблицаЗначений;
	_ТаблицаВетис.Колонки.Добавить("name", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("code", Новый ОписаниеТипов("Строка"));
	
	_Макет = Справочники[ВетисИмяСправочника.IncorporationForm()].ПолучитьМакет("ОК_028_2012");
	
	Для _НомерСтроки = 1 По _Макет.ВысотаТаблицы Цикл
		
		_ТаблицаСтрока = _ТаблицаВетис.Добавить();
		
		_ТаблицаСтрока.name = _Макет.Область(_НомерСтроки, 3).Текст;
		_ТаблицаСтрока.code = _Макет.Область(_НомерСтроки, 2).Текст;
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(_Таблица.name КАК СТРОКА(150)) КАК name,
	|	ВЫРАЗИТЬ(_Таблица.code КАК СТРОКА(5)) КАК code
	|ПОМЕСТИТЬ ВТаблицаВетис
	|ИЗ
	|	&ТаблицаВетис КАК _Таблица
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Справочник.Ссылка КАК Ссылка,
	|	_Справочник.Наименование,
	|	_Справочник.Код,
	|	_Ветис.name КАК name,
	|	_Ветис.code КАК code
	|ИЗ
	|	ВТаблицаВетис КАК _Ветис
	|		ПОЛНОЕ СОЕДИНЕНИЕ Справочник.ВетисIncorporationForm КАК _Справочник
	|		ПО _Ветис.code = _Справочник.Код
	|ГДЕ
	|	ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	_Ветис.name";
	
	Запрос.УстановитьПараметр("ТаблицаВетис", _ТаблицаВетис);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		_Новый = Ложь;
		
		_ЕстьИзменения = Ложь;
		
		Если Выборка.code = NULL Тогда
			Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			Ветис.Журнал_Добавить("- " + Выборка.Наименование, "Ветис.IncorporationForm");
			Продолжить;
			
		ИначеЕсли Выборка.Ссылка = NULL Тогда
			_Новый = Истина;
			
		Иначе
			_ЕстьИзменения = Ложь
			ИЛИ НЕ Выборка.Наименование = СокрЛП(Выборка.name)
			ИЛИ НЕ Выборка.Код = СокрЛП(Выборка.code);
			
		КонецЕсли;
		
		Если _ЕстьИзменения ИЛИ _Новый Тогда
			
			Если _Новый Тогда
				_Элемент = Справочники[ВетисИмяСправочника.IncorporationForm()].СоздатьЭлемент();
				Ветис.Журнал_Добавить("+ " + СокрЛП(Выборка.name), "Ветис.IncorporationForm");
			Иначе
				_Элемент = Выборка.Ссылка.ПолучитьОбъект();
				Ветис.Журнал_Добавить("~ " + СокрЛП(Выборка.name), "Ветис.IncorporationForm");
			КонецЕсли;
			
			_Элемент.Наименование  = СокрЛП(Выборка.name);
			_Элемент.Код  = СокрЛП(Выборка.code);
			
			Попытка
				_Элемент.Записать();
			Исключение
				ВетисОбщегоНазначения.ВывестиСообщениеОбОшибке(ИнформацияОбОшибке(), "Ветис.IncorporationForm");
			КонецПопытки;
			
			
		КонецЕсли;
		
	КонецЦикла;
		
КонецПроцедуры
