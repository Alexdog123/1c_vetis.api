
&НаСервере
Процедура КомандаЗаполнитьНаСервере(пСтрана)
	
	_Страна = пСтрана;
	
	_countryGuid = ?(Ветис.Версия_2_0(), ВетисDictionaryСлой1с, ВетисIkarСлой1с).Country(_Страна);
	
	Если НЕ ЗначениеЗаполнено(_countryGuid) Тогда
		ВетисОбщегоНазначения.ВывестиСообщение("Заполнение справочника ВетисDistrict: нет сопоставления страны.");
		Возврат;
	КонецЕсли;
	
	_Service = ?(Ветис.Версия_2_0(), ВетисIkarService_2_0, ВетисIkarService);
	
	_ТаблицаВетис = Новый ТаблицаЗначений;
	_ТаблицаВетис.Колонки.Добавить("name", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("guid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("regionGuid", Новый ОписаниеТипов("Строка"));
	
	_region = Неопределено; _параметрыР = Неопределено;
	Пока _Service.GetRegionListByCountryСледующий(_countryGuid, _region, _параметрыР) Цикл
		_district = Неопределено; _параметры = Неопределено;
		Пока _Service.GetDistrictListByRegionСледующий(_region.guid, _district, _параметры) Цикл
			ЗаполнитьЗначенияСвойств(_ТаблицаВетис.Добавить(), _district);
		КонецЦикла;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(_Таблица.name КАК СТРОКА(150)) КАК name,
	|	ВЫРАЗИТЬ(_Таблица.guid КАК СТРОКА(36)) КАК guid,
	|	ВЫРАЗИТЬ(_Таблица.regionGuid КАК СТРОКА(36)) КАК regionGuid
	|ПОМЕСТИТЬ ВТаблицаВетис
	|ИЗ
	|	&ТаблицаВетис КАК _Таблица
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Ссылка КАК Ссылка,
	|	_Таблица.Наименование КАК Наименование,
	|	_Соответствие.guid КАК guid
	|ПОМЕСТИТЬ ВСправочник
	|ИЗ
	|	Справочник.ВетисDistrict КАК _Таблица
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВетисСоответствие КАК _Соответствие
	|		ПО _Таблица.Ссылка = _Соответствие.Ссылка
	|ГДЕ
	|	ИСТИНА
	|	И _Таблица.Страна = &Страна
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ Различные
	|	_Таблица.Ссылка КАК Ссылка,
	|	_Таблица.Наименование КАК Наименование,
	|	_Ветис.name КАК name,
	|	_Ветис.guid КАК guid,
	|	_Ветис.regionGuid КАК regionGuid,_Соответствие.Ссылка КАК Регион
	|ИЗ
	|	ВТаблицаВетис КАК _Ветис
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВСправочник КАК _Таблица
	|		ПО _Ветис.guid = _Таблица.guid
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВетисСоответствие КАК _Соответствие
	|		ПО _Ветис.regionGuid = _Соответствие.guid
	|ГДЕ
	|	ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	name";
	
	Запрос.УстановитьПараметр("Страна", _Страна);
	Запрос.УстановитьПараметр("ТаблицаВетис", _ТаблицаВетис);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		_Новый = Ложь;
		
		_ЕстьИзменения = Ложь;
		
		Если Выборка.guid = NULL Тогда
			Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			Ветис.Журнал_Добавить("- " + Выборка.Наименование, "Ветис.District");
			Продолжить;
			
		ИначеЕсли Выборка.Ссылка = NULL Тогда
			_Новый = Истина;
			
		Иначе
			_ЕстьИзменения = Ложь
			ИЛИ НЕ Выборка.Наименование = СокрЛП(Выборка.name);
			
		КонецЕсли;
		
		Если _ЕстьИзменения ИЛИ _Новый Тогда
			
			Если _Новый Тогда
				_Элемент = Справочники[ВетисИмяСправочника.District()].СоздатьЭлемент();
				Ветис.Журнал_Добавить("+ " + СокрЛП(Выборка.name), "Ветис.District");
			Иначе
				_Элемент = Выборка.Ссылка.ПолучитьОбъект();
				Ветис.Журнал_Добавить("~ " + СокрЛП(Выборка.name), "Ветис.District");
			КонецЕсли;
			//Справочники.ВетисDistrict.НайтиПоНаименованию(СокрЛП(Выборка.name))
			_Элемент.Наименование  = СокрЛП(Выборка.name);
			_Элемент.Страна        = _Страна;
			_Элемент.Регион        = Выборка.Регион;
			
			Попытка
				_Элемент.Записать();
				
				Ветис.Соответствие_Добавить(_Элемент.Ссылка, Выборка.guid, Выборка.name);
				
			Исключение
				ВетисОбщегоНазначения.ВывестиСообщениеОбОшибке(ИнформацияОбОшибке(), "Ветис.District");
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаЗаполнить(Команда)
	
	КомандаЗаполнитьНаСервере(Страна);
	
	Элементы.Список.Обновить();
	
КонецПроцедуры

&НаКлиенте
Процедура СтранаОтборНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ВетисФормы.CountryФормаВыбора(ЭтаФорма, "СтранаОтборОбработкаОповещения", СтандартнаяОбработка, Страна);
	
КонецПроцедуры

&НаКлиенте
Процедура СтранаОтборОбработкаОповещения(Результат, Параметр) Экспорт
	
	Если НЕ Результат = Неопределено Тогда
		Страна = Результат;
	КонецЕсли;
	
КонецПроцедуры
