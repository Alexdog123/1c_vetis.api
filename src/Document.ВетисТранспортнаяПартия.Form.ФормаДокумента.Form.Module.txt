
&НаКлиенте
Процедура КомандаЗаполнить(Команда)
	
	ЗаполнитьНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаЗаполнитьТовары(Команда)
	
	//Для каждого _Строка Из Объект.ДокументОснование.Товары Цикл
	//	
	//КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПодборПартий(Команда)
	
	_оо = Новый ОписаниеОповещения("ПодборПартийОбработкаОповещения", ЭтаФорма);
	
	_Параметры = Новый Структура("РежимВыбора, Предприятие", Истина, Объект.ОтправительПредприятие);
	
	ОткрытьФорму("Документ.ВетисТранспортнаяПартия.Форма.ФормаПодборПартий", _Параметры, ЭтаФорма,,,, _оо);
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаОтправить(Команда)
	
	Если НЕ Объект.Проведен Тогда
		Возврат;
	КонецЕсли;
	
	ОтправитьНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаЗаполнитьПартии(Команда)
	ЗаполнитьПартииНаСервере();
КонецПроцедуры


&НаКлиенте
Процедура ПодборПартийОбработкаОповещения(Результат, Параметр) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	_ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	
	_Строки = Объект.Партии.НайтиСтроки(Новый Структура("guid", Результат.guid));
	
	Если _Строки.Количество() = 0 Тогда
		_Строка = Объект.Партии.Добавить();
	Иначе
		_Строка = _Строки[0];
	КонецЕсли;
	
	_Строка.КлючСвязи = _ТекущиеДанные.КлючСтроки;
	_Строка.Номенклатура = _ТекущиеДанные.Номенклатура;
	
	_Строка.guid = Результат.guid;
	_Строка.Дата = Результат.Дата;
	
	_Строка.Количество = Результат.Количество;
	_Строка.КоличествоМест = Результат.КоличествоМест;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНаСервере()
	
	_Объект = РеквизитФормыВЗначение("Объект");
	
	_Объект.Заполнить(Объект.ДокументОснование);
	
	ЗначениеВРеквизитФормы(_Объект, "Объект");
	
КонецПроцедуры

&НаСервере
Процедура ОтправитьНаСервере()
	
	_Отказ = Ложь;
	
	Для каждого _СтрокаСЖ Из Объект.СкладскойЖурнал Цикл
		
		_ПартииСтроки = Объект.Партии.НайтиСтроки(Новый Структура("КлючСвязи", _СтрокаСЖ.КлючСтроки));
		
		ВетисMercuryApplicationsСлой1с.TransportOperation(_СтрокаСЖ, _ПартииСтроки, _Отказ);
		
	КонецЦикла;
	
	Если НЕ _Отказ = Ложь Тогда
		Модифицированность = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДокументОснованиеПриИзменении(Элемент)
	
	ЗаполнитьНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПриАктивизацииСтроки(Элемент)
	
	Если Элементы.Товары.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Элементы.Партии.ОтборСтрок = Новый ФиксированнаяСтруктура("КлючСвязи", Элементы.Товары.ТекущиеДанные.КлючСтроки);
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПартииНаСервере()
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	_Таблица.guid КАК guid,
	|	_Таблица.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	|	_Таблица.SubProductGuid КАК SubProductGuid,
	|	_Таблица.Номенклатура КАК Номенклатура,
	|	_Таблица.ProductItemGuid КАК ProductItemGuid,
	|	_Таблица.КоличествоОстаток КАК КоличествоОстаток,
	|	_Таблица.КоличествоМестОстаток КАК КоличествоМестОстаток
	|ИЗ
	|	РегистрНакопления.ВетисСкладскойЖурнал.Остатки КАК _Таблица
	|ГДЕ
	|	_Таблица.Номенклатура В(&Номенклатура)
	|	И _Таблица.Предприятие = &Предприятие";
	
	Запрос.УстановитьПараметр("", );
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
	КонецЦикла;
	
	
КонецПроцедуры
