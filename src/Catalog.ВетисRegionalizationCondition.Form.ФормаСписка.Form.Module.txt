
&НаКлиенте
Процедура КомандаЗаполнить(Команда)
	
	КомандаЗаполнитьНаСервере();
	
	Элементы.Список.Обновить();
	
КонецПроцедуры

&НаСервере
Процедура КомандаЗаполнитьНаСервере()
	
	Если НЕ Ветис.Версия_2_0() Тогда
		Возврат;
	КонецЕсли;
	
	_ТаблицаВетис = Новый ТаблицаЗначений;
	_ТаблицаВетис.Колонки.Добавить("referenceNumber", Новый ОписаниеТипов("Число"));
	_ТаблицаВетис.Колонки.Добавить("guid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("text", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("strict", Новый ОписаниеТипов("Булево"));
	_ТаблицаВетис.Колонки.Добавить("relatedDiseaseGuid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("relatedDisease", Новый ОписаниеТипов("Строка"));
	
	_Условие = Неопределено; _параметры = Неопределено;
	Пока ВетисRegionalizationService_2_0.GetR13nConditionListСледующий(_Условие, _параметры) Цикл
		_Строка = _ТаблицаВетис.Добавить();
		_Строка.referenceNumber = _Условие.referenceNumber;
		_Строка.guid            = _Условие.guid;
		_Строка.text            = _Условие.text;
		_Строка.strict          = _Условие.strict;
		_Строка.relatedDiseaseGuid  = ?(_Условие.relatedDisease.Количество()=0, "", _Условие.relatedDisease[0].guid);
		_Строка.relatedDisease  = ?(_Условие.relatedDisease.Количество()=0, "", _Условие.relatedDisease[0].name);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(_Таблица.referenceNumber КАК ЧИСЛО) КАК referenceNumber,
	|	ВЫРАЗИТЬ(_Таблица.guid КАК СТРОКА(36)) КАК guid,
	|	ВЫРАЗИТЬ(_Таблица.text КАК СТРОКА(255)) КАК text,
	|	ВЫРАЗИТЬ(_Таблица.strict КАК БУЛЕВО) КАК strict,
	|	ВЫРАЗИТЬ(_Таблица.relatedDiseaseGuid КАК СТРОКА(36)) КАК relatedDiseaseGuid,
	|	ВЫРАЗИТЬ(_Таблица.relatedDisease КАК СТРОКА(255)) КАК relatedDisease
	|ПОМЕСТИТЬ ВТаблицаВетис
	|ИЗ
	|	&ТаблицаВетис КАК _Таблица
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Ссылка КАК Ссылка,
	|	_Таблица.Ссылка.Наименование КАК Наименование,
	|	_Таблица.Ссылка.НомерУсловия КАК НомерУсловия,
	|	_Таблица.Ссылка.ФормулировкаУсловия КАК ФормулировкаУсловия,
	|	_Таблица.Ссылка.Обязательность КАК Обязательность,
	|	_Таблица.Ссылка.Заболевание КАК Заболевание,
	|	_Заболевание.Ссылка КАК СоответствиеЗаболевание,
	|	_Ветис.referenceNumber КАК referenceNumber,
	|	_Ветис.guid КАК guid,
	|	_Ветис.text КАК text,
	|	_Ветис.strict КАК strict,
	|	_Ветис.relatedDiseaseGuid КАК relatedDiseaseGuid,
	|	_Ветис.relatedDisease КАК relatedDisease
	|ИЗ
	|	ВТаблицаВетис КАК _Ветис
	|		ПОЛНОЕ СОЕДИНЕНИЕ Справочник.ВетисRegionalizationCondition КАК _Таблица
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВетисСоответствие КАК _Соответствие
	|			ПО _Таблица.Ссылка = _Соответствие.Ссылка
	|		ПО (_Ветис.guid = _Соответствие.guid)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВетисСоответствие КАК _Заболевание
	|		ПО _Ветис.relatedDiseaseGuid = _Заболевание.guid
	|			И (_Заболевание.Ссылка ССЫЛКА Справочник.ВетисAnimalDisease)
	|ГДЕ
	|	ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	text";
	
	Запрос.УстановитьПараметр("ТаблицаВетис", _ТаблицаВетис);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_СоответствиеЗаболевание = Новый Соответствие;
	
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.СоответствиеЗаболевание = NULL Тогда
			_Заболевание = _СоответствиеЗаболевание.Получить(Выборка.relatedDiseaseGuid);
			Если _Заболевание = Неопределено И ЗначениеЗаполнено(Выборка.relatedDiseaseGuid) Тогда
				_Элемент = Справочники.ВетисAnimalDisease.СоздатьЭлемент();
				_Элемент.Наименование = Выборка.relatedDisease;
				Попытка
					_Элемент.Записать();
					_Заболевание = _Элемент.Ссылка;
					_СоответствиеЗаболевание.Вставить(Выборка.relatedDiseaseGuid, _Элемент.Ссылка);
					Ветис.Соответствие_Добавить(_Элемент.Ссылка, Выборка.relatedDiseaseGuid, Выборка.relatedDisease);
					Ветис.Журнал_Добавить("+ " + СокрЛП(Выборка.relatedDisease), "Ветис.AnimalDisease");
				Исключение
					ВетисОбщегоНазначения.ВывестиСообщениеОбОшибке(ИнформацияОбОшибке(), "Ветис.AnimalDisease");
				КонецПопытки;
			КонецЕсли;
		Иначе
			_Заболевание = Выборка.СоответствиеЗаболевание;
		КонецЕсли;
		
		_Новый = Ложь;
		
		_ЕстьИзменения = Ложь;
		
		Если Выборка.guid = NULL Тогда
			Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			Ветис.Журнал_Добавить("- " + Выборка.relatedDisease, "Ветис.RegionalizationCondition");
			Продолжить;
			
		ИначеЕсли Выборка.Ссылка = NULL Тогда
			_Новый = Истина;
			
		Иначе
			_ЕстьИзменения = Ложь
			ИЛИ НЕ Выборка.НомерУсловия = СокрЛП(Выборка.referenceNumber)
			ИЛИ НЕ Выборка.ФормулировкаУсловия = Выборка.text
			ИЛИ НЕ Выборка.Обязательность = Выборка.strict
			ИЛИ НЕ Выборка.Заболевание = _Заболевание;
			
		КонецЕсли;
		
		Если _ЕстьИзменения ИЛИ _Новый Тогда
			
			Если _Новый Тогда
				_Элемент = Справочники.ВетисRegionalizationCondition.СоздатьЭлемент();
				Ветис.Журнал_Добавить("+ " + СокрЛП(Выборка.text), "Ветис.RegionalizationCondition");
			Иначе
				_Элемент = Выборка.Ссылка.ПолучитьОбъект();
				Ветис.Журнал_Добавить("~ " + СокрЛП(Выборка.text), "Ветис.RegionalizationCondition");
			КонецЕсли;
			
			_Элемент.НомерУсловия        = Выборка.referenceNumber;
			_Элемент.Наименование        = СокрЛП(Выборка.text);
			_Элемент.ФормулировкаУсловия = СокрЛП(Выборка.text);
			_Элемент.Обязательность      = Выборка.strict;
			_Элемент.Заболевание         = _СоответствиеЗаболевание;
			
			Попытка
				_Элемент.Записать();
				
				Ветис.Соответствие_Добавить(_Элемент.Ссылка, Выборка.guid, Выборка.referenceNumber);
				
			Исключение
				ВетисОбщегоНазначения.ВывестиСообщениеОбОшибке(ИнформацияОбОшибке(), "Ветис.RegionalizationCondition");
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры
